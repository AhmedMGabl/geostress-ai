<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoStress AI - Industrial Fracture Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="d-none">
        <div class="spinner-border text-light" role="status" style="width:3rem;height:3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="text-light mt-3 fs-5" id="loading-text">Processing...</div>
    </div>

    <div class="d-flex" style="min-height:100vh">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h4><i class="bi bi-layers-half"></i> GeoStress AI</h4>
                <small class="text-muted-light">Industrial Fracture Analysis v2.0</small>
            </div>

            <ul class="nav flex-column sidebar-nav">
                <li class="nav-item">
                    <a class="nav-link active" data-tab="data" href="#">
                        <i class="bi bi-table"></i> Data Overview
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="viz" href="#">
                        <i class="bi bi-pie-chart"></i> Visualizations
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="inversion" href="#">
                        <i class="bi bi-gear-wide-connected"></i> Stress Inversion
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="models" href="#">
                        <i class="bi bi-bar-chart-line"></i> Model Comparison
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="classify" href="#">
                        <i class="bi bi-diagram-3"></i> ML Classification
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="cluster" href="#">
                        <i class="bi bi-bullseye"></i> Fracture Clustering
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="feedback" href="#">
                        <i class="bi bi-chat-dots"></i> Feedback
                    </a>
                </li>
            </ul>

            <!-- Parameters -->
            <div class="sidebar-section">
                <h6 class="sidebar-heading">Parameters</h6>
                <div class="mb-2">
                    <label class="form-label-sm">Well</label>
                    <select id="well-select" class="form-select form-select-sm">
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label-sm">Stress Regime</label>
                    <select id="regime-select" class="form-select form-select-sm">
                        <option value="strike_slip" selected>Strike-Slip</option>
                        <option value="normal">Normal</option>
                        <option value="thrust">Thrust</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label-sm">Depth (m)</label>
                    <input type="number" id="depth-input" class="form-control form-control-sm" value="3300" min="500" max="6000">
                </div>
                <div class="mb-2">
                    <label class="form-label-sm">Pore Pressure (MPa)
                        <i class="bi bi-info-circle" title="Hydrostatic estimate used if left empty. Pore pressure reduces effective normal stress on fractures, shifting Mohr circles left."></i>
                    </label>
                    <input type="number" id="pp-input" class="form-control form-control-sm" placeholder="Auto (hydrostatic)" step="0.1" min="0" max="200">
                </div>
            </div>

            <!-- Upload -->
            <div class="sidebar-section">
                <h6 class="sidebar-heading">Upload Data</h6>
                <input type="file" id="file-upload" class="form-control form-control-sm" accept=".xls,.xlsx">
                <div id="upload-status" class="small mt-1"></div>
                <div class="mt-2">
                    <span class="badge" id="data-source-badge">Demo Data</span>
                </div>
                <button id="btn-use-demo" class="btn btn-outline-light btn-sm mt-1 d-none" onclick="switchToDemo()">
                    Back to Demo Data
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow-1">
            <!-- Top bar -->
            <div class="topbar d-flex align-items-center justify-content-between px-4">
                <div>
                    <span id="page-title" class="fw-semibold fs-5">Data Overview</span>
                    <span class="text-muted ms-2" id="fracture-count-badge"></span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted small">AI-Powered Geostress Analysis for Oil &amp; Gas</span>
                </div>
            </div>

            <div class="content-area p-4">
                <!-- DATA TAB -->
                <div id="tab-data" class="tab-content active">
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-label">Total Fractures</div>
                                <div class="metric-value" id="total-fractures">--</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-label">Wells</div>
                                <div class="metric-value" id="total-wells">--</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-label">Fracture Types</div>
                                <div class="metric-value" id="total-types">--</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-label">Data Source</div>
                                <div class="metric-value" id="data-source-label">Demo</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Fracture Summary by Well & Type</div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0" id="summary-table">
                                    <thead>
                                        <tr>
                                            <th>Well</th><th>Fracture Type</th><th>Count</th>
                                            <th>Depth Min (m)</th><th>Depth Max (m)</th>
                                            <th>Mean Azimuth (&deg;)</th><th>Mean Dip (&deg;)</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISUALIZATIONS TAB -->
                <div id="tab-viz" class="tab-content">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="loadAllViz()">
                            <i class="bi bi-play-fill"></i> Generate All
                        </button>
                    </div>
                    <div class="row g-3">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">Rose Diagram</div>
                                <div class="card-body text-center">
                                    <img id="rose-img" class="plot-img" alt="Click Generate All">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">Stereonet</div>
                                <div class="card-body text-center">
                                    <img id="stereonet-img" class="plot-img" alt="Click Generate All">
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">Depth Profile</div>
                                <div class="card-body text-center">
                                    <img id="depth-img" class="plot-img" alt="Click Generate All">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INVERSION TAB (Enhanced) -->
                <div id="tab-inversion" class="tab-content">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="runInversion()">
                            <i class="bi bi-play-fill"></i> Run Inversion
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="runAllRegimes()">
                            <i class="bi bi-arrow-repeat"></i> Compare All Regimes
                        </button>
                    </div>

                    <!-- Results metrics -->
                    <div id="inversion-results" class="d-none">
                        <div class="row g-3 mb-4">
                            <div class="col-md-2"><div class="metric-card"><div class="metric-label">&sigma;1 (MPa)</div><div class="metric-value" id="inv-sigma1">--</div></div></div>
                            <div class="col-md-2"><div class="metric-card"><div class="metric-label">&sigma;2 (MPa)</div><div class="metric-value" id="inv-sigma2">--</div></div></div>
                            <div class="col-md-2"><div class="metric-card"><div class="metric-label">&sigma;3 (MPa)</div><div class="metric-value" id="inv-sigma3">--</div></div></div>
                            <div class="col-md-2"><div class="metric-card"><div class="metric-label">R Ratio</div><div class="metric-value" id="inv-R">--</div></div></div>
                            <div class="col-md-2"><div class="metric-card"><div class="metric-label">SHmax (&deg;)</div><div class="metric-value" id="inv-shmax">--</div></div></div>
                            <div class="col-md-2"><div class="metric-card"><div class="metric-label">Pore Pressure</div><div class="metric-value" id="inv-pp">--</div></div></div>
                        </div>

                        <!-- Risk Assessment Banner -->
                        <div id="risk-banner" class="alert mb-4 d-none">
                            <h5 class="alert-heading" id="risk-title"></h5>
                            <div id="risk-body"></div>
                        </div>

                        <!-- Stakeholder Interpretation -->
                        <div id="interpretation-section" class="mb-4 d-none">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <i class="bi bi-lightbulb"></i> Decision Support - What This Means
                                </div>
                                <div class="card-body" id="interpretation-body"></div>
                            </div>
                        </div>

                        <!-- Risk Categories -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="metric-card" style="border-left:4px solid #dc3545">
                                    <div class="metric-label">High Risk Fractures</div>
                                    <div class="metric-value text-danger" id="inv-high-risk">--</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card" style="border-left:4px solid #ffc107">
                                    <div class="metric-label">Moderate Risk</div>
                                    <div class="metric-value text-warning" id="inv-mod-risk">--</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card" style="border-left:4px solid #198754">
                                    <div class="metric-label">Low Risk</div>
                                    <div class="metric-value text-success" id="inv-low-risk">--</div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-lg-6">
                                <div class="card"><div class="card-header">Mohr Circle</div>
                                <div class="card-body text-center"><img id="mohr-img" class="plot-img"></div></div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card"><div class="card-header">Slip Tendency</div>
                                <div class="card-body text-center"><img id="slip-img" class="plot-img"></div></div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card"><div class="card-header">Dilation Tendency</div>
                                <div class="card-body text-center"><img id="dilation-img" class="plot-img"></div></div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card"><div class="card-header">Analysis Dashboard</div>
                                <div class="card-body text-center"><img id="dashboard-img" class="plot-img"></div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Regime comparison table -->
                    <div id="regime-comparison" class="d-none mt-4">
                        <div class="card">
                            <div class="card-header">Regime Comparison</div>
                            <div class="card-body p-0">
                                <table class="table table-striped mb-0" id="regime-table">
                                    <thead><tr>
                                        <th>Regime</th><th>&sigma;1</th><th>&sigma;2</th><th>&sigma;3</th>
                                        <th>R</th><th>SHmax</th><th>&mu;</th><th>Crit. Stressed</th>
                                    </tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODEL COMPARISON TAB (NEW) -->
                <div id="tab-models" class="tab-content">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="runModelComparison()">
                            <i class="bi bi-play-fill"></i> Compare All Models
                        </button>
                    </div>
                    <p class="text-muted small">Compares Random Forest, Gradient Boosting, XGBoost, LightGBM, SVM, and Neural Network on fracture classification using enhanced physics-informed features.</p>

                    <div id="model-results" class="d-none">
                        <!-- Summary metrics -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Best Model</div>
                                    <div class="metric-value" id="mc-best-model">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Best Accuracy</div>
                                    <div class="metric-value" id="mc-best-acc">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Model Agreement</div>
                                    <div class="metric-value" id="mc-agreement">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card" style="border-left:4px solid #ffc107">
                                    <div class="metric-label">Low Confidence Samples</div>
                                    <div class="metric-value" id="mc-low-conf">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Model agreement explanation -->
                        <div id="mc-uncertainty-alert" class="alert alert-info mb-4 d-none">
                            <i class="bi bi-info-circle"></i>
                            <strong>What does Model Agreement mean?</strong>
                            <span id="mc-uncertainty-text"></span>
                        </div>

                        <!-- Ranking table -->
                        <div class="card mb-4">
                            <div class="card-header">Model Ranking (by Cross-Validated Accuracy)</div>
                            <div class="card-body p-0">
                                <table class="table table-striped mb-0" id="mc-ranking-table">
                                    <thead><tr>
                                        <th>Rank</th><th>Model</th><th>CV Accuracy</th><th>F1 Score</th>
                                    </tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Per-model details -->
                        <div id="mc-details-container"></div>
                    </div>
                </div>

                <!-- CLASSIFICATION TAB (Enhanced) -->
                <div id="tab-classify" class="tab-content">
                    <div class="d-flex gap-2 mb-3">
                        <select id="classifier-select" class="form-select form-select-sm" style="width:auto">
                            <option value="random_forest">Random Forest</option>
                            <option value="gradient_boosting">Gradient Boosting</option>
                            <option value="xgboost">XGBoost</option>
                            <option value="lightgbm">LightGBM</option>
                            <option value="svm">SVM</option>
                            <option value="mlp">Neural Network</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="runClassification()">
                            <i class="bi bi-play-fill"></i> Run Classification
                        </button>
                    </div>
                    <p class="text-muted small">Uses enhanced physics-informed features including pore pressure, overburden stress, temperature, fracture density, and fabric strength.</p>

                    <div id="classify-results" class="d-none">
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">CV Accuracy</div>
                                    <div class="metric-value" id="clf-accuracy">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Std Deviation</div>
                                    <div class="metric-value" id="clf-std">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">F1 Score</div>
                                    <div class="metric-value" id="clf-f1">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Classifier</div>
                                    <div class="metric-value" id="clf-type">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">Feature Importances</div>
                                    <div class="card-body" id="feat-imp-container"></div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">Confusion Matrix</div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-bordered mb-0 table-sm" id="confusion-table">
                                                <thead></thead><tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CLUSTERING TAB -->
                <div id="tab-cluster" class="tab-content">
                    <div class="d-flex gap-2 mb-3">
                        <select id="n-clusters-select" class="form-select form-select-sm" style="width:auto">
                            <option value="auto">Auto-detect</option>
                            <option value="2">2 clusters</option>
                            <option value="3">3 clusters</option>
                            <option value="4">4 clusters</option>
                            <option value="5">5 clusters</option>
                            <option value="6">6 clusters</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="runClustering()">
                            <i class="bi bi-play-fill"></i> Run Clustering
                        </button>
                    </div>
                    <div id="cluster-results" class="d-none">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <div class="metric-card">
                                    <div class="metric-label">Fracture Sets Found</div>
                                    <div class="metric-value" id="n-clusters-val">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">Cluster Stereonet</div>
                                    <div class="card-body text-center">
                                        <img id="cluster-img" class="plot-img">
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">Cluster Statistics</div>
                                    <div class="card-body p-0">
                                        <table class="table table-striped mb-0 table-sm" id="cluster-stats-table">
                                            <thead><tr><th>Set</th><th>Mean Az</th><th>Mean Dip</th><th>Count</th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FEEDBACK TAB (NEW) -->
                <div id="tab-feedback" class="tab-content">
                    <div class="row g-3 mb-4">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header"><i class="bi bi-chat-dots"></i> Submit Feedback</div>
                                <div class="card-body">
                                    <p class="text-muted small">Help improve GeoStress AI by rating analysis accuracy. Your feedback trains future model versions.</p>
                                    <div class="mb-3">
                                        <label class="form-label">Analysis Type</label>
                                        <select id="fb-type" class="form-select form-select-sm">
                                            <option value="inversion">Stress Inversion</option>
                                            <option value="classification">Fracture Classification</option>
                                            <option value="clustering">Fracture Clustering</option>
                                            <option value="critically_stressed">Critically Stressed Analysis</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Accuracy Rating</label>
                                        <div id="fb-stars" class="d-flex gap-1">
                                            <button class="btn btn-outline-warning btn-sm fb-star" data-val="1">1</button>
                                            <button class="btn btn-outline-warning btn-sm fb-star" data-val="2">2</button>
                                            <button class="btn btn-warning btn-sm fb-star active" data-val="3">3</button>
                                            <button class="btn btn-outline-warning btn-sm fb-star" data-val="4">4</button>
                                            <button class="btn btn-outline-warning btn-sm fb-star" data-val="5">5</button>
                                        </div>
                                        <small class="text-muted">1 = very inaccurate, 5 = very accurate</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Comments (optional)</label>
                                        <textarea id="fb-comment" class="form-control form-control-sm" rows="3" placeholder="What was inaccurate? What would improve the analysis?"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Your Name (optional)</label>
                                        <input type="text" id="fb-name" class="form-control form-control-sm" placeholder="Anonymous">
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="submitFeedback()">
                                        <i class="bi bi-send"></i> Submit Feedback
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header"><i class="bi bi-graph-up"></i> Feedback Summary</div>
                                <div class="card-body" id="fb-summary-body">
                                    <p class="text-muted">No feedback collected yet. Submit feedback to track accuracy over time.</p>
                                </div>
                            </div>
                            <div class="card mt-3">
                                <div class="card-header"><i class="bi bi-question-circle"></i> Why Feedback Matters</div>
                                <div class="card-body">
                                    <ul class="mb-0 small">
                                        <li><strong>Accuracy tracking</strong>: Monitors how well predictions match field observations</li>
                                        <li><strong>Model improvement</strong>: Low-rated analyses identify where models need retraining</li>
                                        <li><strong>Data quality</strong>: Comments help identify data issues (missing fractures, wrong orientations)</li>
                                        <li><strong>Decision audit trail</strong>: Records expert validation of AI-assisted decisions</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">GeoStress AI</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
