<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoStress AI - Industrial Fracture Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="d-none">
        <div class="spinner-border text-light" role="status" style="width:3rem;height:3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="text-light mt-3 fs-5" id="loading-text">Processing...</div>
        <div class="progress mt-3" style="width:300px;height:8px;display:none" id="loading-progress">
            <div class="progress-bar bg-info" id="loading-bar" style="width:0%"></div>
        </div>
        <div class="text-light small mt-1" id="loading-detail"></div>
    </div>

    <div class="d-flex" style="min-height:100vh">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h4><i class="bi bi-layers-half"></i> GeoStress AI</h4>
                <small class="text-muted-light">Industrial Fracture Analysis v3.0</small>
                <small class="text-muted-light d-block mt-1"><i class="bi bi-clock"></i> Last: <span id="response-time">-</span></small>
            </div>

            <ul class="nav flex-column sidebar-nav">
                <li class="nav-item">
                    <a class="nav-link active" data-tab="executive" href="#">
                        <i class="bi bi-speedometer2"></i> Executive Summary
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="data" href="#">
                        <i class="bi bi-table"></i> Data Overview
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="viz" href="#">
                        <i class="bi bi-pie-chart"></i> Visualizations
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="inversion" href="#">
                        <i class="bi bi-gear-wide-connected"></i> Stress Inversion
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="models" href="#">
                        <i class="bi bi-bar-chart-line"></i> Model Comparison
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="shap" href="#">
                        <i class="bi bi-lightbulb"></i> Why It Predicts
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="classify" href="#">
                        <i class="bi bi-diagram-3"></i> ML Classification
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="cluster" href="#">
                        <i class="bi bi-bullseye"></i> Fracture Clustering
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="sensitivity" href="#">
                        <i class="bi bi-sliders"></i> Sensitivity
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="risk" href="#">
                        <i class="bi bi-shield-exclamation"></i> Risk Matrix
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="uncertainty" href="#">
                        <i class="bi bi-clipboard-pulse"></i> Uncertainty Budget
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="wells" href="#">
                        <i class="bi bi-building"></i> Well Comparison
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="report" href="#">
                        <i class="bi bi-file-earmark-text"></i> Well Report
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="feedback" href="#">
                        <i class="bi bi-chat-dots"></i> Feedback
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="calibration" href="#">
                        <i class="bi bi-bullseye"></i> Calibration
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="decision" href="#">
                        <i class="bi bi-signpost-split"></i> Decisions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="scenarios" href="#">
                        <i class="bi bi-sliders"></i> Scenarios
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="montecarlo" href="#">
                        <i class="bi bi-dice-5"></i> Monte Carlo
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="validation" href="#">
                        <i class="bi bi-check2-all"></i> Data Validation
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="audit" href="#">
                        <i class="bi bi-shield-check"></i> Audit Trail
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="research" href="#">
                        <i class="bi bi-mortarboard"></i> Research & Methods
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="glossary" href="#">
                        <i class="bi bi-book"></i> Glossary
                    </a>
                </li>
            </ul>

            <!-- Parameters -->
            <div class="sidebar-section">
                <h6 class="sidebar-heading">Parameters</h6>
                <div class="mb-2">
                    <label class="form-label-sm">Well</label>
                    <select id="well-select" class="form-select form-select-sm">
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label-sm">Stress Regime</label>
                    <select id="regime-select" class="form-select form-select-sm">
                        <option value="auto" selected>Auto (Best Fit)</option>
                        <option value="strike_slip">Strike-Slip</option>
                        <option value="normal">Normal</option>
                        <option value="thrust">Thrust</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label-sm">Depth (m)</label>
                    <input type="number" id="depth-input" class="form-control form-control-sm" value="3300" min="500" max="6000">
                </div>
                <div class="mb-2">
                    <label class="form-label-sm">Pore Pressure (MPa)
                        <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Hydrostatic estimate used if left empty. Pore pressure reduces effective normal stress on fractures, shifting Mohr circles left."></i>
                    </label>
                    <input type="number" id="pp-input" class="form-control form-control-sm" placeholder="Auto (hydrostatic)" step="0.1" min="0" max="200">
                </div>
            </div>

            <!-- Full Pipeline -->
            <div class="sidebar-section">
                <button id="btn-pipeline" class="btn btn-warning btn-sm w-100 fw-bold" onclick="runFullPipeline()">
                    <i class="bi bi-rocket-takeoff"></i> Run Full Pipeline
                </button>
                <div class="small text-muted-light mt-1">Chains all analyses in one click</div>
            </div>

            <!-- Upload -->
            <div class="sidebar-section">
                <h6 class="sidebar-heading">Upload Data</h6>
                <input type="file" id="file-upload" class="form-control form-control-sm" accept=".xls,.xlsx">
                <div id="upload-status" class="small mt-1"></div>
                <div class="mt-2">
                    <span class="badge" id="data-source-badge">Demo Data</span>
                </div>
                <button id="btn-use-demo" class="btn btn-outline-light btn-sm mt-1 d-none" onclick="switchToDemo()">
                    Back to Demo Data
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow-1">
            <!-- Top bar -->
            <div class="topbar d-flex align-items-center justify-content-between px-4">
                <div>
                    <span id="page-title" class="fw-semibold fs-5">Data Overview</span>
                    <span class="text-muted ms-2" id="fracture-count-badge"></span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted small">AI-Powered Geostress Analysis for Oil &amp; Gas</span>
                </div>
            </div>

            <div class="content-area p-4">
                <!-- Pipeline Progress Panel -->
                <div id="pipeline-panel" class="d-none mb-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center py-2">
                            <span><i class="bi bi-rocket-takeoff"></i> <strong>Full Analysis Pipeline</strong></span>
                            <button class="btn btn-sm btn-outline-dark" onclick="closePipelinePanel()"><i class="bi bi-x-lg"></i></button>
                        </div>
                        <div class="card-body py-3">
                            <div id="pipeline-steps" class="d-flex gap-1 mb-2 flex-wrap"></div>
                            <div class="progress mb-2" style="height:6px">
                                <div id="pipeline-bar" class="progress-bar bg-warning" style="width:0%;transition:width 0.3s"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small id="pipeline-status" class="text-muted">Preparing...</small>
                                <small id="pipeline-elapsed" class="text-muted"></small>
                            </div>
                            <div id="pipeline-summary" class="d-none mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- EXECUTIVE SUMMARY TAB -->
                <div id="tab-executive" class="tab-content active">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4 class="mb-1"><i class="bi bi-speedometer2"></i> Executive Summary</h4>
                            <p class="text-muted mb-0">Plain-language overview for decision-makers. No jargon, just actionable insights.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary btn-sm" onclick="runExecutiveSummary()">
                                <i class="bi bi-arrow-clockwise"></i> Generate Summary
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="runSufficiencyCheck()">
                                <i class="bi bi-clipboard-check"></i> Data Sufficiency
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="runSafetyCheck()">
                                <i class="bi bi-shield-exclamation"></i> Safety Check
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="runFieldConsistency()">
                                <i class="bi bi-globe2"></i> Field Consistency
                            </button>
                            <button class="btn btn-success btn-sm" onclick="runEvidenceChain()">
                                <i class="bi bi-list-check"></i> Full Evidence Chain
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="runGuidedWizard()">
                                <i class="bi bi-signpost-split"></i> Guided Wizard
                            </button>
                            <button class="btn btn-dark btn-sm" onclick="exportPdfReport()">
                                <i class="bi bi-file-earmark-pdf"></i> PDF Report
                            </button>
                            <button class="btn btn-success btn-sm" onclick="exportFullJsonReport()">
                                <i class="bi bi-filetype-json"></i> JSON Report
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="runBatchAnalysis()">
                                <i class="bi bi-collection"></i> Batch All Wells
                            </button>
                            <button class="btn btn-outline-dark btn-sm" onclick="runDecisionReadiness()">
                                <i class="bi bi-clipboard-check"></i> Decision Readiness
                            </button>
                        </div>
                    </div>

                    <!-- Decision Readiness -->
                    <div id="readiness-results" class="d-none mb-4">
                        <div class="card border-dark">
                            <div class="card-header bg-dark text-white">
                                <i class="bi bi-clipboard-check"></i> Decision Readiness Assessment
                            </div>
                            <div class="card-body" id="readiness-body"></div>
                        </div>
                    </div>

                    <!-- Overall Risk Banner -->
                    <div id="exec-risk-banner" class="d-none mb-4">
                        <div id="exec-risk-alert" class="alert p-4"></div>
                    </div>

                    <!-- Summary Sections -->
                    <div id="exec-sections" class="mb-4"></div>

                    <!-- Evidence Chain Results -->
                    <div id="evidence-results" class="d-none mb-4">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white"><i class="bi bi-list-check"></i> Evidence Chain — Decision Support</div>
                            <div class="card-body">
                                <div id="evidence-summary" class="alert mb-3"></div>
                                <div id="evidence-items"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Guided Wizard Results -->
                    <div id="wizard-results" class="d-none mb-4"></div>

                    <!-- Batch Analysis Results -->
                    <div id="batch-results" class="d-none mb-4">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <i class="bi bi-collection"></i> Batch Field Analysis — All Wells
                            </div>
                            <div class="card-body" id="batch-body"></div>
                        </div>
                    </div>

                    <!-- Safety Check Results -->
                    <div id="safety-results" class="d-none mb-4">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-shield-exclamation"></i> Prediction Safety Check</div>
                            <div class="card-body">
                                <div id="safety-decision" class="alert mb-3"></div>
                                <div id="safety-blockers"></div>
                                <div id="safety-warnings"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Field Consistency Results -->
                    <div id="field-results" class="d-none mb-4">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-globe2"></i> Field-Scale Consistency</div>
                            <div class="card-body">
                                <div id="field-rec" class="alert mb-3"></div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <h6 class="small fw-bold">SHmax Consistency</h6>
                                        <div id="field-shmax"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="small fw-bold">Fracture Type Similarity</h6>
                                        <div id="field-types"></div>
                                    </div>
                                </div>
                                <h6 class="small fw-bold">Per-Well Results</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm small">
                                        <thead><tr><th>Well</th><th>SHmax</th><th>σ1</th><th>σ3</th><th>Misfit</th><th>Fractures</th></tr></thead>
                                        <tbody id="field-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Sufficiency Results -->
                    <div id="suff-results" class="d-none">
                        <h5 class="mb-3"><i class="bi bi-clipboard-check"></i> Data Sufficiency Assessment</h5>
                        <div id="suff-overall" class="alert mb-3"></div>
                        <div class="table-responsive mb-3">
                            <table class="table table-sm">
                                <thead><tr><th>Analysis</th><th>Status</th><th>Assessment</th><th>Min Data Needed</th></tr></thead>
                                <tbody id="suff-table-body"></tbody>
                            </table>
                        </div>
                        <div id="suff-recs"></div>
                    </div>
                </div>

                <!-- DATA TAB -->
                <div id="tab-data" class="tab-content">
                    <div class="alert alert-light border py-2 mb-3 small"><i class="bi bi-info-circle text-primary"></i> <strong>Data Overview</strong> &mdash; Summary statistics of all fracture measurements loaded from borehole image logs. Check fracture counts, depth ranges, and orientation distributions before running any analysis.</div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-label">Total Fractures</div>
                                <div class="metric-value" id="total-fractures">--</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-label">Wells</div>
                                <div class="metric-value" id="total-wells">--</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-label">Fracture Types</div>
                                <div class="metric-value" id="total-types">--</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-label">Data Source</div>
                                <div class="metric-value" id="data-source-label">Demo</div>
                            </div>
                        </div>
                    </div>
                    <!-- Data Quality Banner -->
                    <div id="quality-banner" class="d-none mb-4">
                        <div class="card" id="quality-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-shield-check"></i> Data Quality Assessment</span>
                                <span class="badge fs-6" id="quality-grade-badge">--</span>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center gap-3 mb-2">
                                    <div class="fs-4 fw-bold" id="quality-score">--</div>
                                    <div class="flex-grow-1">
                                        <div class="progress" style="height:8px">
                                            <div class="progress-bar" id="quality-bar" style="width:0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div id="quality-issues"></div>
                                <div id="quality-warnings"></div>
                                <div id="quality-recommendations"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Anomaly Detection -->
                    <div class="mb-3">
                        <button class="btn btn-outline-warning btn-sm" onclick="runAnomalyDetection()">
                            <i class="bi bi-search"></i> Scan for Data Anomalies
                        </button>
                    </div>
                    <div id="anomaly-results" class="d-none mb-4">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <i class="bi bi-exclamation-triangle"></i> Data Anomaly Detection
                            </div>
                            <div class="card-body" id="anomaly-body"></div>
                        </div>
                    </div>

                    <!-- Auto-Analysis Overview -->
                    <div id="overview-panel" class="d-none mb-4">
                        <div class="card border-dark">
                            <div class="card-header bg-dark text-white">
                                <i class="bi bi-speedometer2"></i> Quick Analysis Overview
                                <button class="btn btn-sm btn-outline-light float-end" onclick="runOverview()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="row g-3 text-center">
                                    <div class="col"><div class="metric-card"><div class="metric-label">SHmax Direction <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Direction of maximum horizontal stress. Determines optimal drilling direction and hydraulic fracture propagation."></i></div><div class="metric-value" id="ov-shmax">--</div></div></div>
                                    <div class="col"><div class="metric-card"><div class="metric-label">Stress Regime <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Auto-detected faulting regime (normal, strike-slip, or thrust) based on best fit to fracture data."></i></div><div class="metric-value" id="ov-regime">--</div></div></div>
                                    <div class="col"><div class="metric-card"><div class="metric-label">Critically Stressed <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Percentage of fractures above the Mohr-Coulomb failure line. These fractures may act as fluid conduits and could reactivate during operations."></i></div><div class="metric-value" id="ov-cs">--</div></div></div>
                                    <div class="col"><div class="metric-card"><div class="metric-label">Risk Level <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Overall operational risk based on critically stressed fractures, data quality, model confidence, and sensitivity analysis."></i></div><div class="metric-value" id="ov-risk">--</div></div></div>
                                    <div class="col"><div class="metric-card"><div class="metric-label">Data Quality <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Grade A-F based on sample size, completeness, value ranges, and consistency of the fracture measurement data."></i></div><div class="metric-value" id="ov-quality">--</div></div></div>
                                    <div class="col"><div class="metric-card"><div class="metric-label">Decision <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="GO: Proceed with operations. CONDITIONAL: Proceed with additional monitoring. NO-GO: Do not proceed without further data or analysis."></i></div><div class="metric-value" id="ov-gonogo">--</div></div></div>
                                </div>
                                <!-- Warnings & Disclaimers -->
                                <div id="ov-warnings" class="mt-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Navigation for Stakeholders -->
                    <div class="card mb-4 border-info">
                        <div class="card-header bg-info bg-opacity-10">
                            <i class="bi bi-signpost-split"></i> Analysis Workflow
                        </div>
                        <div class="card-body">
                            <div class="row g-2 text-center">
                                <div class="col">
                                    <a href="#" data-tab="viz" class="nav-link text-decoration-none">
                                        <div class="p-2 rounded bg-light"><i class="bi bi-pie-chart fs-4 d-block text-primary"></i>
                                        <small>1. Visualize</small></div>
                                    </a>
                                </div>
                                <div class="col">
                                    <a href="#" data-tab="inversion" class="nav-link text-decoration-none">
                                        <div class="p-2 rounded bg-light"><i class="bi bi-gear-wide-connected fs-4 d-block text-primary"></i>
                                        <small>2. Stress Inversion</small></div>
                                    </a>
                                </div>
                                <div class="col">
                                    <a href="#" data-tab="models" class="nav-link text-decoration-none">
                                        <div class="p-2 rounded bg-light"><i class="bi bi-bar-chart-line fs-4 d-block text-primary"></i>
                                        <small>3. Compare Models</small></div>
                                    </a>
                                </div>
                                <div class="col">
                                    <a href="#" data-tab="sensitivity" class="nav-link text-decoration-none">
                                        <div class="p-2 rounded bg-light"><i class="bi bi-sliders fs-4 d-block text-primary"></i>
                                        <small>4. Sensitivity</small></div>
                                    </a>
                                </div>
                                <div class="col">
                                    <a href="#" data-tab="risk" class="nav-link text-decoration-none">
                                        <div class="p-2 rounded bg-light"><i class="bi bi-shield-exclamation fs-4 d-block text-danger"></i>
                                        <small>5. Risk Matrix</small></div>
                                    </a>
                                </div>
                                <div class="col">
                                    <a href="#" data-tab="uncertainty" class="nav-link text-decoration-none">
                                        <div class="p-2 rounded bg-light"><i class="bi bi-clipboard-pulse fs-4 d-block text-info"></i>
                                        <small>6. Uncertainty</small></div>
                                    </a>
                                </div>
                                <div class="col">
                                    <a href="#" data-tab="report" class="nav-link text-decoration-none">
                                        <div class="p-2 rounded bg-light"><i class="bi bi-file-earmark-text fs-4 d-block text-success"></i>
                                        <small>7. Report</small></div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Fracture Summary by Well & Type</div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0" id="summary-table">
                                    <thead>
                                        <tr>
                                            <th>Well</th><th>Fracture Type</th><th>Count</th>
                                            <th>Depth Min (m)</th><th>Depth Max (m)</th>
                                            <th>Mean Azimuth (&deg;)</th><th>Mean Dip (&deg;)</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISUALIZATIONS TAB -->
                <div id="tab-viz" class="tab-content">
                    <div class="alert alert-light border py-2 mb-3 small"><i class="bi bi-info-circle text-primary"></i> <strong>Visualizations</strong> &mdash; Visual plots showing fracture orientation patterns. <em>Rose diagrams</em> show which compass directions fractures face (like a wind rose). <em>Stereonets</em> project 3D orientations onto a 2D circle. <em>Depth profiles</em> show how fractures change with depth.</div>
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="loadAllViz()">
                            <i class="bi bi-play-fill"></i> Generate All
                        </button>
                    </div>
                    <div class="row g-3">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">Rose Diagram</div>
                                <div class="card-body text-center">
                                    <img id="rose-img" class="plot-img" alt="Click Generate All">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">Stereonet</div>
                                <div class="card-body text-center">
                                    <img id="stereonet-img" class="plot-img" alt="Click Generate All">
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">Depth Profile</div>
                                <div class="card-body text-center">
                                    <img id="depth-img" class="plot-img" alt="Click Generate All">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INVERSION TAB (Enhanced) -->
                <div id="tab-inversion" class="tab-content">
                    <div class="alert alert-light border py-2 mb-3 small"><i class="bi bi-info-circle text-primary"></i> <strong>Stress Inversion</strong> &mdash; The core analysis: estimates underground stress magnitudes and directions from fracture orientations. <strong>Key output:</strong> SHmax (maximum horizontal stress direction) determines optimal drilling direction. The Mohr circle shows which fractures are close to failure.</div>
                    <div class="d-flex gap-2 mb-3 flex-wrap">
                        <button class="btn btn-primary btn-sm" onclick="runInversion()">
                            <i class="bi bi-play-fill"></i> Run Inversion
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="runAllRegimes()">
                            <i class="bi bi-arrow-repeat"></i> Compare All Regimes
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="runBayesian()">
                            <i class="bi bi-distribute-vertical"></i> Bayesian Uncertainty
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportInversion()">
                            <i class="bi bi-download"></i> Export Results (CSV)
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportData()">
                            <i class="bi bi-filetype-csv"></i> Export Raw Data
                        </button>
                    </div>

                    <!-- Auto Regime Detection Banner -->
                    <div id="auto-regime-banner" class="d-none mb-4">
                        <div class="card border-success">
                            <div class="card-header bg-success bg-opacity-10">
                                <i class="bi bi-robot"></i> Automatic Regime Detection
                                <span class="badge ms-2" id="auto-regime-confidence"></span>
                            </div>
                            <div class="card-body">
                                <p id="auto-regime-summary" class="mb-3"></p>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped mb-0" id="auto-regime-table">
                                        <thead><tr>
                                            <th>Regime</th><th>Misfit</th>
                                            <th>&sigma;1</th><th>&sigma;3</th>
                                            <th>R</th><th>SHmax</th><th>&mu;</th>
                                            <th></th>
                                        </tr></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bayesian MCMC Results -->
                    <div id="bayesian-results" class="d-none mb-4">
                        <div class="card border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <i class="bi bi-distribute-vertical"></i> Bayesian MCMC Uncertainty Bounds
                                <span class="badge bg-info ms-2" id="bayes-convergence"></span>
                            </div>
                            <div class="card-body">
                                <p class="small text-muted" id="bayes-summary"></p>
                                <div id="bayes-params-body"></div>
                                <div class="mt-2 small text-muted" id="bayes-meta"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Results metrics -->
                    <div id="inversion-results" class="d-none">
                        <div class="mb-2"><span id="inv-quality-badge" class="badge bg-secondary">Data: --</span></div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-2"><div class="metric-card"><div class="metric-label">&sigma;1 (MPa) <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Maximum principal stress. The largest compressive stress in the rock mass. Higher values indicate deeper or more compressed rock."></i></div><div class="metric-value" id="inv-sigma1">--</div></div></div>
                            <div class="col-md-2"><div class="metric-card"><div class="metric-label">&sigma;2 (MPa) <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Intermediate principal stress. Derived from &sigma;1, &sigma;3, and R ratio."></i></div><div class="metric-value" id="inv-sigma2">--</div></div></div>
                            <div class="col-md-2"><div class="metric-card"><div class="metric-label">&sigma;3 (MPa) <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Minimum principal stress. The least compressive stress. Fractures tend to open perpendicular to this direction."></i></div><div class="metric-value" id="inv-sigma3">--</div></div></div>
                            <div class="col-md-2"><div class="metric-card"><div class="metric-label">R Ratio <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Stress shape ratio: (&sigma;2-&sigma;3)/(&sigma;1-&sigma;3). Range 0-1. R near 0 means &sigma;2&asymp;&sigma;3 (prolate stress); R near 1 means &sigma;1&asymp;&sigma;2 (oblate stress)."></i></div><div class="metric-value" id="inv-R">--</div></div></div>
                            <div class="col-md-2"><div class="metric-card"><div class="metric-label">SHmax (&deg;) <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Maximum horizontal stress direction (degrees from North). CRITICAL FOR DRILLING: Wells drilled parallel to SHmax are most stable. Hydraulic fractures propagate along SHmax."></i></div><div class="metric-value" id="inv-shmax">--</div></div></div>
                            <div class="col-md-2"><div class="metric-card"><div class="metric-label">Pore Pressure <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Fluid pressure in rock pores (MPa). Reduces effective normal stress on fractures, making them more likely to slip. Higher Pp = more critically stressed fractures."></i></div><div class="metric-value" id="inv-pp">--</div></div></div>
                        </div>

                        <!-- Risk Assessment Banner -->
                        <div id="risk-banner" class="alert mb-4 d-none">
                            <h5 class="alert-heading" id="risk-title"></h5>
                            <div id="risk-body"></div>
                        </div>

                        <!-- Stakeholder Interpretation -->
                        <div id="interpretation-section" class="mb-4 d-none">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <i class="bi bi-lightbulb"></i> Decision Support - What This Means
                                </div>
                                <div class="card-body" id="interpretation-body"></div>
                            </div>
                        </div>

                        <!-- Risk Categories -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="metric-card" style="border-left:4px solid #dc3545">
                                    <div class="metric-label">High Risk Fractures <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Fractures with slip tendency > 0.8. These are very close to failure and may reactivate during drilling or injection. Avoid operations near these fractures."></i></div>
                                    <div class="metric-value text-danger" id="inv-high-risk">--</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card" style="border-left:4px solid #ffc107">
                                    <div class="metric-label">Moderate Risk <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Fractures with slip tendency 0.6-0.8. These could be reactivated under pressure changes. Monitor during operations and plan contingencies."></i></div>
                                    <div class="metric-value text-warning" id="inv-mod-risk">--</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card" style="border-left:4px solid #198754">
                                    <div class="metric-label">Low Risk <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Fractures with slip tendency < 0.6. These are relatively stable under current stress conditions. Normal operations are safe."></i></div>
                                    <div class="metric-value text-success" id="inv-low-risk">--</div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-lg-6">
                                <div class="card"><div class="card-header">Mohr Circle</div>
                                <div class="card-body text-center"><img id="mohr-img" class="plot-img"></div></div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card"><div class="card-header">Slip Tendency</div>
                                <div class="card-body text-center"><img id="slip-img" class="plot-img"></div></div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card"><div class="card-header">Dilation Tendency</div>
                                <div class="card-body text-center"><img id="dilation-img" class="plot-img"></div></div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card"><div class="card-header">Analysis Dashboard</div>
                                <div class="card-body text-center"><img id="dashboard-img" class="plot-img"></div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Regime comparison table -->
                    <div id="regime-comparison" class="d-none mt-4">
                        <div class="card">
                            <div class="card-header">Regime Comparison</div>
                            <div class="card-body p-0">
                                <table class="table table-striped mb-0" id="regime-table">
                                    <thead><tr>
                                        <th>Regime</th><th>&sigma;1</th><th>&sigma;2</th><th>&sigma;3</th>
                                        <th>R</th><th>SHmax</th><th>&mu;</th><th>Crit. Stressed</th>
                                    </tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODEL COMPARISON TAB (NEW) -->
                <div id="tab-models" class="tab-content">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="runModelComparison(false)">
                            <i class="bi bi-play-fill"></i> Full Comparison
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="runModelComparison(true)">
                            <i class="bi bi-lightning"></i> Quick Compare (~3x faster)
                        </button>
                    </div>
                    <div class="alert alert-light border py-2 mb-3 small"><i class="bi bi-info-circle text-primary"></i> <strong>Model Comparison</strong> &mdash; Runs 7 different AI algorithms on the same data and ranks them by accuracy. The best model is recommended automatically. <em>Why multiple models?</em> Different algorithms capture different patterns &mdash; comparing ensures the most reliable one is chosen for your specific data.</div>

                    <div id="model-results" class="d-none">
                        <!-- Ranking criterion notice -->
                        <div id="mc-ranking-notice" class="d-none alert alert-info py-2 mb-3 small"></div>
                        <!-- Summary metrics -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Best Model</div>
                                    <div class="metric-value" id="mc-best-model">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Best Accuracy</div>
                                    <div class="metric-value" id="mc-best-acc">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Model Agreement</div>
                                    <div class="metric-value" id="mc-agreement">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card" style="border-left:4px solid #ffc107">
                                    <div class="metric-label">Low Confidence Samples</div>
                                    <div class="metric-value" id="mc-low-conf">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Model agreement explanation -->
                        <div id="mc-uncertainty-alert" class="alert alert-info mb-4 d-none">
                            <i class="bi bi-info-circle"></i>
                            <strong>What does Model Agreement mean?</strong>
                            <span id="mc-uncertainty-text"></span>
                        </div>

                        <!-- Ranking table -->
                        <div class="card mb-4">
                            <div class="card-header">Model Ranking (by Cross-Validated Accuracy)</div>
                            <div class="card-body p-0">
                                <table class="table table-striped mb-0" id="mc-ranking-table">
                                    <thead><tr>
                                        <th>Rank</th><th>Model</th><th>CV Accuracy</th><th>Balanced Acc.</th><th>F1 Score</th><th>Overfit Gap</th>
                                    </tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Conformal confidence -->
                        <div id="mc-conformal-section" class="d-none mb-4">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <i class="bi bi-shield-check"></i> Prediction Confidence (Conformal Calibration)
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="small text-muted">Mean Confidence</div>
                                                <div class="fw-bold fs-5" id="mc-conf-mean">--</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="small text-muted">High Confidence (&ge;80%)</div>
                                                <div class="fw-bold fs-5 text-success" id="mc-conf-high">--</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="small text-muted">Uncertain (&lt;50%)</div>
                                                <div class="fw-bold fs-5 text-danger" id="mc-conf-uncertain">--</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="small text-muted">Min Confidence</div>
                                                <div class="fw-bold fs-5" id="mc-conf-min">--</div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="small text-muted mt-2 mb-0">
                                        <strong>What this means:</strong> Conformal prediction provides calibrated confidence scores.
                                        Fractures with &lt;50% confidence should be reviewed by an expert before operational decisions.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Generalization Assessment -->
                        <div id="mc-generalization" class="d-none mb-4">
                            <div class="card border-warning">
                                <div class="card-header bg-warning bg-opacity-10">
                                    <i class="bi bi-clipboard-check"></i> Generalization Assessment
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-4">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="small text-muted">Train-Test Gap</div>
                                                <div class="fw-bold fs-5" id="mc-gen-gap">--</div>
                                                <div class="small text-muted">&lt;5% is good</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="small text-muted">CV Stability (std)</div>
                                                <div class="fw-bold fs-5" id="mc-gen-stability">--</div>
                                                <div class="small text-muted">&lt;5% is stable</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="small text-muted">Min Class Size</div>
                                                <div class="fw-bold fs-5" id="mc-gen-min-class">--</div>
                                                <div class="small text-muted">&ge;30 for reliable metrics</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="mc-gen-warnings"></div>
                                </div>
                            </div>
                        </div>

                        <!-- SMOTE Info -->
                        <div id="mc-smote-info" class="d-none alert alert-info py-2 mb-3 small"></div>

                        <!-- Model Comparison Chart -->
                        <div id="mc-chart-container" class="d-none card mb-4">
                            <div class="card-header"><i class="bi bi-bar-chart-fill"></i> Accuracy Comparison Chart</div>
                            <div class="card-body text-center">
                                <img id="mc-chart-img" class="plot-img" src="" alt="Model comparison chart">
                            </div>
                        </div>

                        <!-- Per-model details -->
                        <div id="mc-details-container"></div>
                    </div>

                    <!-- Learning Curve -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-graph-up"></i> Learning Curve — Do We Need More Data?</span>
                            <button class="btn btn-outline-primary btn-sm" onclick="runLearningCurve()">
                                <i class="bi bi-play-fill"></i> Compute
                            </button>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small">Shows how model accuracy changes with training set size. If the curve has plateaued, more data of the same type won't help — you need better features or different data sources.</p>
                            <div id="lc-results" class="d-none">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <div class="metric-card">
                                            <div class="metric-label">Convergence</div>
                                            <div class="metric-value" id="lc-convergence">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="metric-card">
                                            <div class="metric-label">Current Accuracy</div>
                                            <div class="metric-value" id="lc-current-acc">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="metric-card">
                                            <div class="metric-label">Total Samples</div>
                                            <div class="metric-value" id="lc-n-samples">--</div>
                                        </div>
                                    </div>
                                </div>
                                <div id="lc-convergence-msg" class="alert alert-info small mb-3"></div>
                                <div id="lc-chart-container" class="d-none text-center mb-3">
                                    <img id="lc-chart-img" class="plot-img" src="" alt="Learning curve chart">
                                </div>
                                <div class="card mb-3">
                                    <div class="card-header">Accuracy vs Training Size</div>
                                    <div class="card-body p-0">
                                        <table class="table table-sm mb-0" id="lc-table">
                                            <thead><tr><th>Samples</th><th>Train Acc</th><th>Val Acc</th><th>Balanced Acc</th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div id="lc-projections" class="d-none">
                                    <h6>Data Projections</h6>
                                    <div id="lc-projection-list"></div>
                                </div>
                                <div id="lc-per-class" class="d-none">
                                    <h6>Per-Class F1 vs Training Size</h6>
                                    <table class="table table-sm" id="lc-class-table">
                                        <thead><tr id="lc-class-header"></tr></thead>
                                        <tbody id="lc-class-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hierarchical Classification -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-diagram-3"></i> Hierarchical Classification — Better Rare-Type Detection</span>
                            <button class="btn btn-outline-primary btn-sm" onclick="runHierarchical()">
                                <i class="bi bi-play-fill"></i> Run
                            </button>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small">Two-level approach: first detects rare vs common fracture types, then sub-classifies. This helps when some fracture types have very few samples (e.g., Boundary: 13 samples).</p>
                            <div id="hier-results" class="d-none">
                                <div id="hier-recommendation" class="alert mb-3"></div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <div class="metric-label">Approach</div>
                                            <div class="metric-value" id="hier-approach" style="font-size:1rem">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <div class="metric-label">Flat Balanced Acc</div>
                                            <div class="metric-value" id="hier-flat-bal">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <div class="metric-label">Hierarchical Balanced Acc</div>
                                            <div class="metric-value" id="hier-hier-bal">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <div class="metric-label">L1 (Rare/Common) Acc</div>
                                            <div class="metric-value" id="hier-l1-acc">--</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card mb-3">
                                    <div class="card-header">Per-Class F1 Comparison</div>
                                    <div class="card-body p-0">
                                        <table class="table table-sm mb-0" id="hier-class-table">
                                            <thead><tr>
                                                <th>Class</th><th>Samples</th><th>Type</th><th>Flat F1</th><th>Hierarchical F1</th><th>Change</th>
                                            </tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Depth-Zone Classification -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-layers"></i> Depth-Zone Classification — Depth-Specific Models</span>
                            <button class="btn btn-outline-primary btn-sm" onclick="runDepthZoneClassify()">
                                <i class="bi bi-play-fill"></i> Run
                            </button>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small">Fracture behavior changes with depth (different stress regimes). Trains separate models per depth zone and compares to the global model. May improve accuracy for depth-variable datasets.</p>
                            <div id="depthzone-results" class="d-none"></div>
                        </div>
                    </div>

                    <!-- Bootstrap Confidence Intervals -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-bar-chart-steps"></i> Confidence Intervals — How Reliable Are Predictions?</span>
                            <button class="btn btn-outline-primary btn-sm" onclick="runBootstrapCI()">
                                <i class="bi bi-play-fill"></i> Compute 95% CI
                            </button>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small">Bootstrap resampling (200x) to compute 95% confidence intervals for per-class metrics. Industrial-grade: "F1 = 0.85 [0.78 - 0.91]" instead of just "F1 = 0.85".</p>
                            <div id="ci-results" class="d-none">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <div class="metric-label">Reliability</div>
                                            <div class="metric-value" id="ci-reliability">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <div class="metric-label">Accuracy</div>
                                            <div class="metric-value" id="ci-accuracy">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <div class="metric-label">Accuracy CI</div>
                                            <div class="metric-value" id="ci-accuracy-range">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <div class="metric-label">Bootstraps</div>
                                            <div class="metric-value" id="ci-n-boot">--</div>
                                        </div>
                                    </div>
                                </div>
                                <div id="ci-reliability-msg" class="alert mb-3 small"></div>
                                <div id="ci-chart-container" class="d-none text-center mb-3">
                                    <img id="ci-chart-img" class="plot-img" src="" alt="Bootstrap CI chart">
                                </div>
                                <div class="card">
                                    <div class="card-header">Per-Class 95% Confidence Intervals</div>
                                    <div class="card-body p-0">
                                        <table class="table table-sm mb-0" id="ci-class-table">
                                            <thead><tr>
                                                <th>Class</th><th>F1</th><th>F1 CI</th><th>Precision</th><th>Precision CI</th><th>Recall</th><th>Recall CI</th>
                                            </tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SHAP EXPLAINABILITY TAB (NEW) -->
                <div id="tab-shap" class="tab-content">
                    <div class="alert alert-light border py-2 mb-3 small"><i class="bi bi-info-circle text-primary"></i> <strong>Why It Predicts</strong> &mdash; Shows which fracture features (depth, angle, orientation) most influence the AI classification. SHAP values reveal the &ldquo;reasoning&rdquo; behind each prediction &mdash; critical for trusting AI decisions in operations.</div>
                    <div class="d-flex gap-2 mb-3">
                        <select id="shap-classifier-select" class="form-select form-select-sm" style="width:auto">
                            <option value="gradient_boosting" selected>Gradient Boosting</option>
                            <option value="random_forest">Random Forest</option>
                            <option value="xgboost">XGBoost</option>
                            <option value="lightgbm">LightGBM</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="runShapExplanation()">
                            <i class="bi bi-play-fill"></i> Explain Predictions
                        </button>
                    </div>
                    <p class="text-muted small">
                        Uses SHAP (SHapley Additive exPlanations) to show <strong>why</strong> the model makes its predictions.
                        Each feature gets an importance score based on its actual contribution, not just correlation.
                        This helps stakeholders understand and trust the AI's fracture classifications.
                    </p>

                    <div id="shap-results" class="d-none">
                        <!-- SHAP summary metrics -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Explanation Method</div>
                                    <div class="metric-value" id="shap-method">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Model Used</div>
                                    <div class="metric-value" id="shap-model">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Features Analyzed</div>
                                    <div class="metric-value" id="shap-n-features">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Samples Explained</div>
                                    <div class="metric-value" id="shap-n-samples">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Global feature importance -->
                        <div class="row g-3 mb-4">
                            <div class="col-lg-7">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="bi bi-bar-chart"></i> Global Feature Importance (What Drives Predictions Most)
                                    </div>
                                    <div class="card-body" id="shap-global-container"></div>
                                </div>
                            </div>
                            <div class="col-lg-5">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="bi bi-info-circle"></i> What This Means for Decisions
                                    </div>
                                    <div class="card-body" id="shap-explanation-text">
                                        <p class="text-muted">Run the explanation to see feature importance insights.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Per-class importance -->
                        <div id="shap-class-section" class="d-none mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-diagram-3"></i> What Drives Each Fracture Type Classification
                                </div>
                                <div class="card-body" id="shap-class-container"></div>
                            </div>
                        </div>

                        <!-- Sample explanations -->
                        <div id="shap-sample-section" class="d-none">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-search"></i> Individual Fracture Explanations (Most Distinctive Samples)
                                </div>
                                <div class="card-body" id="shap-sample-container"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CLASSIFICATION TAB (Enhanced) -->
                <div id="tab-classify" class="tab-content">
                    <div class="alert alert-light border py-2 mb-3 small"><i class="bi bi-info-circle text-primary"></i> <strong>ML Classification</strong> &mdash; Uses machine learning to automatically categorize fractures by type (e.g., continuous, discontinuous, brecciated). Accuracy metrics show how reliable the classification is. Conformal prediction adds calibrated confidence intervals.</div>
                    <div class="d-flex gap-2 mb-3">
                        <select id="classifier-select" class="form-select form-select-sm" style="width:auto">
                            <option value="random_forest">Random Forest</option>
                            <option value="gradient_boosting">Gradient Boosting</option>
                            <option value="xgboost">XGBoost</option>
                            <option value="lightgbm">LightGBM</option>
                            <option value="svm">SVM</option>
                            <option value="mlp">Neural Network</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="runClassification()">
                            <i class="bi bi-play-fill"></i> Run Classification
                        </button>
                    </div>
                    <p class="text-muted small">Uses enhanced physics-informed features including pore pressure, overburden stress, temperature, fracture density, and fabric strength.</p>

                    <div id="classify-results" class="d-none">
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">CV Accuracy</div>
                                    <div class="metric-value" id="clf-accuracy">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Std Deviation</div>
                                    <div class="metric-value" id="clf-std">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">F1 Score</div>
                                    <div class="metric-value" id="clf-f1">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Classifier</div>
                                    <div class="metric-value" id="clf-type">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">Feature Importances</div>
                                    <div class="card-body" id="feat-imp-container"></div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">Confusion Matrix</div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-bordered mb-0 table-sm" id="confusion-table">
                                                <thead></thead><tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CLUSTERING TAB -->
                <div id="tab-cluster" class="tab-content">
                    <div class="alert alert-light border py-2 mb-3 small"><i class="bi bi-info-circle text-primary"></i> <strong>Fracture Clustering</strong> &mdash; Groups fractures that share similar orientations into &ldquo;fracture sets.&rdquo; Each set likely formed under the same stress conditions. Knowing fracture sets helps predict reservoir connectivity and fluid flow paths.</div>
                    <div class="d-flex gap-2 mb-3">
                        <select id="n-clusters-select" class="form-select form-select-sm" style="width:auto">
                            <option value="auto">Auto-detect</option>
                            <option value="2">2 clusters</option>
                            <option value="3">3 clusters</option>
                            <option value="4">4 clusters</option>
                            <option value="5">5 clusters</option>
                            <option value="6">6 clusters</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="runClustering()">
                            <i class="bi bi-play-fill"></i> Run Clustering
                        </button>
                    </div>
                    <div id="cluster-results" class="d-none">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <div class="metric-card">
                                    <div class="metric-label">Fracture Sets Found</div>
                                    <div class="metric-value" id="n-clusters-val">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">Cluster Stereonet</div>
                                    <div class="card-body text-center">
                                        <img id="cluster-img" class="plot-img">
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">Cluster Statistics</div>
                                    <div class="card-body p-0">
                                        <table class="table table-striped mb-0 table-sm" id="cluster-stats-table">
                                            <thead><tr><th>Set</th><th>Mean Az</th><th>Mean Dip</th><th>Count</th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FEEDBACK TAB (NEW) -->
                <div id="tab-feedback" class="tab-content">
                    <div class="alert alert-light border py-2 mb-3 small"><i class="bi bi-info-circle text-primary"></i> <strong>Feedback Loop</strong> &mdash; Tell the AI when its predictions are wrong. Each correction improves future accuracy. The trust score shows how much confidence to place in the model based on data quality and correction history.</div>

                    <!-- Trust Score Banner -->
                    <div class="card mb-4 border-0 shadow-sm" id="trust-score-card">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="mb-1"><i class="bi bi-shield-check"></i> Model Trust Score</h5>
                                    <p class="text-muted small mb-0">Composite confidence metric combining expert feedback, calibration, data quality, corrections, and sample size.</p>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="runTrustScore()">
                                    <i class="bi bi-arrow-clockwise"></i> Compute
                                </button>
                            </div>
                            <div id="trust-score-body">
                                <p class="text-muted small">Click "Compute" to assess overall model trustworthiness. The trust score updates as you submit feedback and corrections.</p>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header"><i class="bi bi-chat-dots"></i> Submit Feedback</div>
                                <div class="card-body">
                                    <p class="text-muted small">Help improve GeoStress AI by rating analysis accuracy. Your feedback trains future model versions.</p>
                                    <div class="mb-3">
                                        <label class="form-label">Analysis Type</label>
                                        <select id="fb-type" class="form-select form-select-sm">
                                            <option value="inversion">Stress Inversion</option>
                                            <option value="classification">Fracture Classification</option>
                                            <option value="clustering">Fracture Clustering</option>
                                            <option value="critically_stressed">Critically Stressed Analysis</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Accuracy Rating</label>
                                        <div id="fb-stars" class="d-flex gap-1">
                                            <button class="btn btn-outline-warning btn-sm fb-star" data-val="1">1</button>
                                            <button class="btn btn-outline-warning btn-sm fb-star" data-val="2">2</button>
                                            <button class="btn btn-warning btn-sm fb-star active" data-val="3">3</button>
                                            <button class="btn btn-outline-warning btn-sm fb-star" data-val="4">4</button>
                                            <button class="btn btn-outline-warning btn-sm fb-star" data-val="5">5</button>
                                        </div>
                                        <small class="text-muted">1 = very inaccurate, 5 = very accurate</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Comments (optional)</label>
                                        <textarea id="fb-comment" class="form-control form-control-sm" rows="3" placeholder="What was inaccurate? What would improve the analysis?"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Your Name (optional)</label>
                                        <input type="text" id="fb-name" class="form-control form-control-sm" placeholder="Anonymous">
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="submitFeedback()">
                                        <i class="bi bi-send"></i> Submit Feedback
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header"><i class="bi bi-graph-up"></i> Feedback Summary</div>
                                <div class="card-body" id="fb-summary-body">
                                    <p class="text-muted">No feedback collected yet. Submit feedback to track accuracy over time.</p>
                                </div>
                            </div>

                            <!-- Actionable Insights -->
                            <div id="fb-insights-section" class="d-none mt-3">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <i class="bi bi-lightbulb"></i> Actionable Insights
                                    </div>
                                    <div class="card-body" id="fb-insights-body"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Label Correction Section -->
                    <div class="row g-3 mb-4">
                        <div class="col-lg-6">
                            <div class="card border-warning">
                                <div class="card-header">
                                    <i class="bi bi-pencil-square"></i> Correct a Classification
                                    <small class="text-muted ms-2">(Closes the feedback loop)</small>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small">
                                        When you see a misclassified fracture, submit the correct label here.
                                        After collecting corrections, click "Retrain" to update the model.
                                    </p>
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <label class="form-label small">Fracture Index</label>
                                            <input type="number" id="corr-idx" class="form-control form-control-sm" value="0" min="0">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Original Type</label>
                                            <select id="corr-original" class="form-select form-select-sm">
                                                <option value="">Model's prediction</option>
                                                <option value="Boundary">Boundary</option>
                                                <option value="Brecciated">Brecciated</option>
                                                <option value="Continuous">Continuous</option>
                                                <option value="Discontinuous">Discontinuous</option>
                                                <option value="Vuggy">Vuggy</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Correct Type</label>
                                            <select id="corr-correct" class="form-select form-select-sm">
                                                <option value="Boundary">Boundary</option>
                                                <option value="Brecciated">Brecciated</option>
                                                <option value="Continuous">Continuous</option>
                                                <option value="Discontinuous">Discontinuous</option>
                                                <option value="Vuggy">Vuggy</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-2 d-flex gap-2">
                                        <button class="btn btn-warning btn-sm" onclick="submitCorrection()">
                                            <i class="bi bi-check-lg"></i> Submit Correction
                                        </button>
                                        <span class="small text-muted align-self-center" id="corr-count">0 corrections pending</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-arrow-repeat"></i> Retrain with Expert Corrections
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small">
                                        After submitting label corrections, retrain the model to incorporate
                                        expert knowledge. This is how the AI improves from human feedback.
                                    </p>
                                    <button class="btn btn-success btn-sm" onclick="retrainModel()" id="btn-retrain" disabled>
                                        <i class="bi bi-arrow-repeat"></i> Retrain Model
                                    </button>
                                    <div id="retrain-result" class="mt-2 d-none"></div>
                                </div>
                            </div>
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-question-circle"></i> How the Feedback Loop Works</span>
                                    <button class="btn btn-success btn-sm" onclick="runFeedbackEffectiveness()">
                                        <i class="bi bi-graph-up-arrow"></i> Track Effectiveness
                                    </button>
                                </div>
                                <div class="card-body">
                                    <ol class="mb-0 small">
                                        <li><strong>Rate analyses</strong> to track model accuracy over time</li>
                                        <li><strong>Correct labels</strong> when you spot misclassified fractures</li>
                                        <li><strong>Retrain</strong> to incorporate corrections into the model</li>
                                        <li><strong>Compare</strong> before/after accuracy to verify improvement</li>
                                        <li><strong>Repeat</strong> as more field data becomes available</li>
                                    </ol>
                                </div>
                            </div>
                            <!-- Feedback Effectiveness Results -->
                            <div id="effectiveness-results" class="d-none mt-3">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <i class="bi bi-graph-up-arrow"></i> Feedback Effectiveness Report
                                    </div>
                                    <div class="card-body" id="effectiveness-body"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Learning Section -->
                    <div class="card mt-4 border-info">
                        <div class="card-header bg-info text-white">
                            <i class="bi bi-bullseye"></i> Active Learning — Which Fractures to Review Next
                        </div>
                        <div class="card-body">
                            <p class="text-muted small">
                                The AI identifies fractures it's most uncertain about. Reviewing these
                                gives the biggest improvement per expert-hour — this is human-in-the-loop learning.
                            </p>
                            <div class="d-flex gap-2 mb-3">
                                <button class="btn btn-info btn-sm" onclick="runActiveLearning()">
                                    <i class="bi bi-bullseye"></i> Find Uncertain Fractures
                                </button>
                            </div>

                            <div id="al-results" class="d-none">
                                <div class="mb-3" id="al-summary-text"></div>

                                <!-- Learning Curve -->
                                <div id="al-learning-curve" class="d-none mb-3">
                                    <h6><i class="bi bi-graph-up-arrow"></i> Learning Curve</h6>
                                    <div id="al-curve-body"></div>
                                </div>

                                <!-- Coverage Gaps -->
                                <div id="al-coverage" class="d-none mb-3">
                                    <h6><i class="bi bi-exclamation-diamond"></i> Data Coverage Gaps</h6>
                                    <div id="al-coverage-body"></div>
                                </div>

                                <!-- Suggested Samples -->
                                <div id="al-suggestions" class="d-none">
                                    <h6><i class="bi bi-list-check"></i> Fractures for Expert Review</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead><tr>
                                                <th>#</th><th>Well</th><th>Depth</th><th>Az</th><th>Dip</th>
                                                <th>Current Label</th><th>Predicted</th><th>Confidence</th><th>Mismatch</th>
                                            </tr></thead>
                                            <tbody id="al-table-body"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ═══════ Sensitivity Tab ═══════ -->
                <div id="tab-sensitivity" class="tab-content">
                    <h5 class="mb-3">Parameter Sensitivity Analysis</h5>
                    <p class="text-muted">How do results change when assumptions vary? Essential for understanding how robust your conclusions are.</p>

                    <!-- Interactive What-If Explorer -->
                    <div class="card border-primary mb-4">
                        <div class="card-header bg-primary text-white"><i class="bi bi-sliders2"></i> Interactive What-If Explorer</div>
                        <div class="card-body">
                            <p class="small text-muted">Adjust parameters below and click "Run What-If" to see how results change in real time.</p>
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">Friction Coefficient (μ)</label>
                                    <input type="range" class="form-range" id="whatif-friction" min="0.2" max="1.0" step="0.05" value="0.6">
                                    <div class="d-flex justify-content-between small text-muted">
                                        <span>0.2 (weak)</span>
                                        <span id="whatif-friction-val" class="fw-bold text-primary">0.6</span>
                                        <span>1.0 (strong)</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">Pore Pressure (MPa)</label>
                                    <input type="range" class="form-range" id="whatif-pp" min="0" max="50" step="1" value="0">
                                    <div class="d-flex justify-content-between small text-muted">
                                        <span>0 (dry)</span>
                                        <span id="whatif-pp-val" class="fw-bold text-primary">0</span>
                                        <span>50 (overpressured)</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">Depth (m)</label>
                                    <input type="range" class="form-range" id="whatif-depth" min="1000" max="6000" step="100" value="3000">
                                    <div class="d-flex justify-content-between small text-muted">
                                        <span>1000m</span>
                                        <span id="whatif-depth-val" class="fw-bold text-primary">3000</span>
                                        <span>6000m</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="runWhatIf()">
                                <i class="bi bi-play-fill"></i> Run What-If
                            </button>
                            <div id="whatif-results" class="mt-3 d-none"></div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="runSensitivity()">
                            <i class="bi bi-sliders"></i> Run Full Sensitivity Analysis
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="runSensitivityHeatmap()">
                            <i class="bi bi-grid-3x3"></i> Sensitivity Heatmap
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="runWorstCase()">
                            <i class="bi bi-exclamation-octagon"></i> Worst-Case Scenarios
                        </button>
                    </div>
                    <div id="worst-case-results" class="d-none mb-4">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <i class="bi bi-exclamation-octagon"></i> Worst-Case Scenario Analysis
                            </div>
                            <div class="card-body" id="worst-case-body"></div>
                        </div>
                    </div>
                    <div id="heatmap-results" class="d-none mb-4">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <i class="bi bi-grid-3x3"></i> Sensitivity Heatmap — Friction × Pore Pressure
                            </div>
                            <div class="card-body" id="heatmap-body"></div>
                        </div>
                    </div>

                    <!-- Tornado Diagram -->
                    <div id="sens-tornado" class="d-none mb-4">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-tornado"></i> Tornado Diagram — Impact on Critically Stressed %</div>
                            <div class="card-body" id="sens-tornado-body"></div>
                        </div>
                    </div>

                    <!-- Risk Implications -->
                    <div id="sens-risks" class="d-none mb-4">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark"><i class="bi bi-exclamation-triangle"></i> Risk Implications</div>
                            <div class="card-body" id="sens-risks-body"></div>
                        </div>
                    </div>

                    <!-- Regime Comparison Table -->
                    <div id="sens-regime" class="d-none mb-4">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-arrows-angle-expand"></i> Regime Comparison</div>
                            <div class="card-body" id="sens-regime-body"></div>
                        </div>
                    </div>

                    <!-- Friction & Pore Pressure Detail -->
                    <div class="row g-3">
                        <div class="col-lg-6">
                            <div id="sens-friction" class="d-none">
                                <div class="card">
                                    <div class="card-header"><i class="bi bi-speedometer2"></i> Friction Coefficient Sensitivity</div>
                                    <div class="card-body" id="sens-friction-body"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div id="sens-pp" class="d-none">
                                <div class="card">
                                    <div class="card-header"><i class="bi bi-droplet"></i> Pore Pressure Sensitivity</div>
                                    <div class="card-body" id="sens-pp-body"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ═══════ Risk Matrix Tab ═══════ -->
                <div id="tab-risk" class="tab-content">
                    <h5 class="mb-3">Operational Risk Assessment</h5>
                    <p class="text-muted">GO / NO-GO decision framework combining all analysis results.</p>

                    <button class="btn btn-primary btn-sm mb-3" onclick="runRiskMatrix()">
                        <i class="bi bi-shield-check"></i> Compute Risk Matrix
                    </button>

                    <!-- Overall Risk Banner -->
                    <div id="risk-overall" class="d-none mb-4">
                        <div class="card" id="risk-overall-card">
                            <div class="card-body text-center py-4">
                                <h2 id="risk-go-nogo" class="mb-2"></h2>
                                <div id="risk-score-badge" class="fs-4 fw-bold mb-2"></div>
                                <p id="risk-detail" class="text-muted mb-0"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Factors Table -->
                    <div id="risk-factors" class="d-none">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-list-check"></i> Risk Factor Breakdown</div>
                            <div class="card-body">
                                <table class="table table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Risk Factor</th>
                                            <th>Score</th>
                                            <th>Detail</th>
                                            <th>Mitigation</th>
                                        </tr>
                                    </thead>
                                    <tbody id="risk-factors-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ═══════ Uncertainty Budget Tab ═══════ -->
                <div id="tab-uncertainty" class="tab-content">
                    <h5 class="mb-3">Uncertainty Budget</h5>
                    <p class="text-muted">Where does the most uncertainty come from? This tells you what data to acquire next to get the biggest improvement in prediction confidence.</p>

                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="runUncertaintyBudget(false)">
                            <i class="bi bi-clipboard-pulse"></i> Compute Budget
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="runUncertaintyBudget(true)">
                            <i class="bi bi-distribute-vertical"></i> Include Bayesian (slower)
                        </button>
                    </div>

                    <!-- Overall Uncertainty Banner -->
                    <div id="ub-overall" class="d-none mb-4">
                        <div class="card" id="ub-overall-card">
                            <div class="card-body text-center py-4">
                                <h2 id="ub-level" class="mb-2"></h2>
                                <div class="fs-4 fw-bold mb-2" id="ub-total-score"></div>
                                <p id="ub-dominant" class="text-muted mb-0"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Stakeholder Summary -->
                    <div id="ub-summary" class="d-none mb-4">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <i class="bi bi-megaphone"></i> What This Means
                            </div>
                            <div class="card-body" id="ub-summary-body"></div>
                        </div>
                    </div>

                    <!-- Source Rankings -->
                    <div id="ub-sources" class="d-none mb-4">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-sort-down"></i> Uncertainty Sources (Ranked by Impact)</div>
                            <div class="card-body" id="ub-sources-body"></div>
                        </div>
                    </div>

                    <!-- Recommended Actions -->
                    <div id="ub-actions" class="d-none">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <i class="bi bi-signpost-split"></i> Recommended Actions (Priority Order)
                            </div>
                            <div class="card-body" id="ub-actions-body"></div>
                        </div>
                    </div>
                </div>

                <!-- ═══════ Well Comparison Tab ═══════ -->
                <div id="tab-wells" class="tab-content">
                    <h5 class="mb-3">Multi-Well Comparison</h5>
                    <p class="text-muted">Compare stress fields, model performance, and data quality across wells.</p>

                    <button class="btn btn-primary btn-sm mb-3" onclick="runWellComparison()">
                        <i class="bi bi-building"></i> Compare Wells
                    </button>

                    <!-- Consistency Checks -->
                    <div id="wells-consistency" class="d-none mb-4">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-check2-all"></i> Consistency Checks</div>
                            <div class="card-body" id="wells-consistency-body"></div>
                        </div>
                    </div>

                    <!-- Well Results Table -->
                    <div id="wells-table" class="d-none mb-4">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-table"></i> Per-Well Results</div>
                            <div class="card-body" id="wells-table-body"></div>
                        </div>
                    </div>

                    <!-- Cross-Validation -->
                    <div id="wells-crossval" class="d-none">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-arrow-left-right"></i> Cross-Well Classification Accuracy</div>
                            <div class="card-body" id="wells-crossval-body"></div>
                        </div>
                    </div>
                </div>

                <!-- ═══════ Well Report Tab ═══════ -->
                <div id="tab-report" class="tab-content">
                    <h5 class="mb-3">Stakeholder Well Report</h5>
                    <p class="text-muted">Generate a comprehensive report for printing or stakeholder presentation.</p>

                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="generateReport()">
                            <i class="bi bi-file-earmark-text"></i> Generate Report
                        </button>
                        <button class="btn btn-outline-secondary btn-sm d-none" id="btn-print-report" onclick="window.print()">
                            <i class="bi bi-printer"></i> Print Report
                        </button>
                    </div>

                    <div id="report-content" class="d-none">
                        <!-- Executive Summary -->
                        <div class="card mb-3 border-primary">
                            <div class="card-header bg-primary text-white"><i class="bi bi-file-text"></i> Executive Summary</div>
                            <div class="card-body fs-6" id="report-exec-summary"></div>
                        </div>

                        <!-- Stress State -->
                        <div class="card mb-3">
                            <div class="card-header"><i class="bi bi-arrows-angle-expand"></i> Stress State</div>
                            <div class="card-body" id="report-stress"></div>
                        </div>

                        <!-- Risk Assessment -->
                        <div class="card mb-3">
                            <div class="card-header"><i class="bi bi-shield-exclamation"></i> Risk Assessment</div>
                            <div class="card-body" id="report-risk"></div>
                        </div>

                        <!-- Recommendations -->
                        <div class="card mb-3 border-success">
                            <div class="card-header bg-success text-white"><i class="bi bi-signpost-split"></i> Operational Recommendations</div>
                            <div class="card-body" id="report-recommendations"></div>
                        </div>

                        <!-- Data Quality -->
                        <div class="card mb-3">
                            <div class="card-header"><i class="bi bi-clipboard-data"></i> Data Quality</div>
                            <div class="card-body" id="report-quality"></div>
                        </div>
                    </div>
                </div>

                <!-- Calibration Tab -->
                <div id="tab-calibration" class="tab-content">
                    <h5 class="mb-3">Model Calibration Assessment</h5>
                    <p class="text-muted">Are the model's confidence values reliable? Calibration measures whether "80% confident" truly means 80% accurate.</p>

                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="runCalibration()">
                            <i class="bi bi-bullseye"></i> Run Calibration Check
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="runOODCheck()">
                            <i class="bi bi-exclamation-triangle"></i> Distribution Check
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="runDataRecommendations()">
                            <i class="bi bi-lightbulb"></i> Data Recommendations
                        </button>
                    </div>

                    <!-- Calibration Results -->
                    <div id="calibration-results" class="d-none">
                        <div class="row mb-3" id="calibration-metrics"></div>
                        <div class="card mb-3">
                            <div class="card-header"><i class="bi bi-bar-chart"></i> Confidence vs. Accuracy</div>
                            <div class="card-body" id="calibration-bins"></div>
                        </div>
                        <div class="card mb-3">
                            <div class="card-header"><i class="bi bi-diagram-3"></i> Per-Class Calibration</div>
                            <div class="card-body" id="calibration-per-class"></div>
                        </div>
                    </div>

                    <!-- OOD Results -->
                    <div id="ood-results" class="d-none">
                        <div class="card mb-3" id="ood-card"></div>
                    </div>

                    <!-- Data Recommendations -->
                    <div id="data-rec-results" class="d-none">
                        <div id="data-rec-content"></div>
                    </div>
                </div>

                <!-- Decision Support Tab -->
                <div id="tab-decision" class="tab-content">
                    <h5 class="mb-3"><i class="bi bi-signpost-split"></i> Decision Support Matrix</h5>
                    <p class="text-muted small">Compares all stress regime options side-by-side with go/no-go recommendations, trade-offs, and confidence levels. Designed for non-technical stakeholders making drilling decisions.</p>

                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="runDecisionMatrix()">
                            <i class="bi bi-play-fill"></i> Generate Decision Matrix
                        </button>
                    </div>

                    <div id="dm-results" class="d-none">
                        <!-- Recommended Action -->
                        <div id="dm-action" class="alert alert-primary mb-3">
                            <i class="bi bi-lightbulb-fill me-1"></i>
                            <strong>Recommended Action:</strong>
                            <span id="dm-action-text"></span>
                        </div>

                        <!-- Confidence Assessment -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Overall Confidence</div>
                                    <div class="metric-value" id="dm-confidence">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Data Quality</div>
                                    <div class="metric-value" id="dm-quality">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Regime Certainty</div>
                                    <div class="metric-value" id="dm-regime-cert">--</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Fractures</div>
                                    <div class="metric-value" id="dm-n-frac">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Regime Options Table -->
                        <div class="card mb-3">
                            <div class="card-header"><i class="bi bi-table"></i> Regime Comparison</div>
                            <div class="card-body p-0">
                                <table class="table table-sm table-striped mb-0" id="dm-options-table">
                                    <thead><tr>
                                        <th>Regime</th><th>&sigma;1</th><th>&sigma;3</th><th>SHmax</th><th>Misfit</th><th>Crit. Stressed</th><th>Risk</th><th>Go/No-Go</th>
                                    </tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Risk Comparison -->
                        <div id="dm-risk-comparison" class="d-none row g-3 mb-3">
                            <div class="col-md-4">
                                <div class="card h-100 border-success">
                                    <div class="card-body text-center">
                                        <div class="small text-muted">Safest Option</div>
                                        <div class="fw-bold" id="dm-safest">--</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100 border-primary">
                                    <div class="card-body text-center">
                                        <div class="small text-muted">Best Data Fit</div>
                                        <div class="fw-bold" id="dm-best-fit">--</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100 border-warning">
                                    <div class="card-body text-center">
                                        <div class="small text-muted">Most Conservative</div>
                                        <div class="fw-bold" id="dm-conservative">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Trade-offs -->
                        <div id="dm-tradeoffs" class="d-none">
                            <h6><i class="bi bi-exclamation-triangle"></i> Key Trade-offs</h6>
                            <div id="dm-tradeoff-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Scenario Comparison Tab -->
                <div id="tab-scenarios" class="tab-content">
                    <h5 class="mb-3"><i class="bi bi-sliders"></i> What-If Scenario Comparison</h5>
                    <p class="text-muted small">Compare different stress regime assumptions side-by-side. See how pore pressure and regime choice affect drilling decisions. Define 2-6 scenarios below.</p>

                    <div class="card mb-3">
                        <div class="card-header">Define Scenarios</div>
                        <div class="card-body">
                            <div id="scenario-list">
                                <div class="row g-2 mb-2 scenario-row">
                                    <div class="col-md-3"><input type="text" class="form-control form-control-sm scenario-name" placeholder="Scenario name" value="Normal Fault"></div>
                                    <div class="col-md-3">
                                        <select class="form-select form-select-sm scenario-regime">
                                            <option value="normal" selected>Normal</option>
                                            <option value="strike_slip">Strike-Slip</option>
                                            <option value="thrust">Thrust</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3"><input type="number" class="form-control form-control-sm scenario-pp" placeholder="Pore pressure (MPa)" value=""></div>
                                    <div class="col-md-3"><button class="btn btn-outline-danger btn-sm" onclick="removeScenario(this)"><i class="bi bi-trash"></i></button></div>
                                </div>
                                <div class="row g-2 mb-2 scenario-row">
                                    <div class="col-md-3"><input type="text" class="form-control form-control-sm scenario-name" placeholder="Scenario name" value="Strike-Slip"></div>
                                    <div class="col-md-3">
                                        <select class="form-select form-select-sm scenario-regime">
                                            <option value="normal">Normal</option>
                                            <option value="strike_slip" selected>Strike-Slip</option>
                                            <option value="thrust">Thrust</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3"><input type="number" class="form-control form-control-sm scenario-pp" placeholder="Pore pressure (MPa)" value=""></div>
                                    <div class="col-md-3"><button class="btn btn-outline-danger btn-sm" onclick="removeScenario(this)"><i class="bi bi-trash"></i></button></div>
                                </div>
                                <div class="row g-2 mb-2 scenario-row">
                                    <div class="col-md-3"><input type="text" class="form-control form-control-sm scenario-name" placeholder="Scenario name" value="Thrust"></div>
                                    <div class="col-md-3">
                                        <select class="form-select form-select-sm scenario-regime">
                                            <option value="normal">Normal</option>
                                            <option value="strike_slip">Strike-Slip</option>
                                            <option value="thrust" selected>Thrust</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3"><input type="number" class="form-control form-control-sm scenario-pp" placeholder="Pore pressure (MPa)" value=""></div>
                                    <div class="col-md-3"><button class="btn btn-outline-danger btn-sm" onclick="removeScenario(this)"><i class="bi bi-trash"></i></button></div>
                                </div>
                            </div>
                            <div class="d-flex gap-2 mt-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="addScenario()"><i class="bi bi-plus"></i> Add Scenario</button>
                                <button class="btn btn-primary btn-sm" onclick="runScenarios()"><i class="bi bi-play-fill"></i> Compare Scenarios</button>
                            </div>
                        </div>
                    </div>

                    <div id="scenario-results" class="d-none">
                        <div id="scenario-recommendation" class="alert alert-success mb-3"></div>
                        <div id="scenario-sensitivity-msg" class="alert alert-warning mb-3 small"></div>

                        <div class="card mb-3">
                            <div class="card-header">Scenario Results</div>
                            <div class="card-body p-0">
                                <table class="table table-sm table-striped mb-0" id="scenario-table">
                                    <thead><tr>
                                        <th>Scenario</th><th>Regime</th><th>&sigma;1</th><th>&sigma;3</th><th>SHmax</th><th>R</th><th>&mu;</th><th>Pp (MPa)</th><th>Misfit</th><th>Crit. Stressed %</th>
                                    </tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="scenario-spread" class="d-none">
                            <div class="card">
                                <div class="card-header">Parameter Sensitivity Across Scenarios</div>
                                <div class="card-body p-0">
                                    <table class="table table-sm mb-0" id="scenario-spread-table">
                                        <thead><tr><th>Parameter</th><th>Min</th><th>Max</th><th>Range</th><th>CV %</th></tr></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monte Carlo Tab -->
                <div id="tab-montecarlo" class="tab-content">
                    <h5 class="mb-3"><i class="bi bi-dice-5"></i> Monte Carlo Uncertainty Propagation</h5>
                    <p class="text-muted">How do measurement errors affect your results? This propagates realistic uncertainties (azimuth ±5°, dip ±3°, depth ±2m) through the full inversion to quantify output precision.</p>

                    <div class="row g-3 mb-3">
                        <div class="col-md-2">
                            <label class="form-label small">Simulations</label>
                            <input type="number" id="mc-nsims" class="form-control form-control-sm" value="200" min="50" max="1000">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Az σ (°)</label>
                            <input type="number" id="mc-az-std" class="form-control form-control-sm" value="5" min="1" max="20" step="0.5">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Dip σ (°)</label>
                            <input type="number" id="mc-dip-std" class="form-control form-control-sm" value="3" min="1" max="15" step="0.5">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Depth σ (m)</label>
                            <input type="number" id="mc-dep-std" class="form-control form-control-sm" value="2" min="0.5" max="20" step="0.5">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary btn-sm w-100" onclick="runMonteCarlo()">
                                <i class="bi bi-dice-5"></i> Run
                            </button>
                        </div>
                    </div>

                    <div id="mc-results" class="d-none">
                        <!-- Reliability Banner -->
                        <div id="mc-reliability" class="alert mb-3"></div>

                        <!-- Statistics Table -->
                        <div class="card mb-3">
                            <div class="card-header"><i class="bi bi-table"></i> Output Distributions (95% CI)</div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm small">
                                        <thead><tr><th>Parameter</th><th>Mean</th><th>Median</th><th>Std Dev</th><th>95% CI Lower</th><th>95% CI Upper</th><th>CI Width</th></tr></thead>
                                        <tbody id="mc-stats-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Sensitivity Ranking -->
                        <div class="card mb-3">
                            <div class="card-header"><i class="bi bi-sort-down"></i> Input Sensitivity Ranking</div>
                            <div class="card-body" id="mc-sensitivity-body"></div>
                        </div>
                    </div>
                </div>

                <!-- Data Validation Tab -->
                <div id="tab-validation" class="tab-content">
                    <h5 class="mb-3"><i class="bi bi-check2-all"></i> Domain Constraint Validation</h5>
                    <p class="text-muted">Validates your data against physical and geological constraints before analysis. Catches impossible values, unusual combinations, and data anomalies.</p>

                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="runDomainValidation()">
                            <i class="bi bi-check2-all"></i> Validate Data
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="runCrossWellCV()">
                            <i class="bi bi-building"></i> Cross-Well Validation
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="runExpertEnsemble()">
                            <i class="bi bi-people"></i> Expert Ensemble
                        </button>
                    </div>

                    <!-- Domain Validation Results -->
                    <div id="val-results" class="d-none mb-4">
                        <div id="val-status" class="alert mb-3"></div>
                        <div id="val-issues-body"></div>
                    </div>

                    <!-- Cross-Well CV Results -->
                    <div id="cwcv-results" class="d-none mb-4">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-building"></i> Leave-One-Well-Out Cross-Validation</div>
                            <div class="card-body">
                                <div id="cwcv-transfer" class="alert mb-3"></div>
                                <div class="table-responsive">
                                    <table class="table table-sm small">
                                        <thead><tr><th>Well (Held Out)</th><th>Train</th><th>Test</th><th>Accuracy</th><th>Balanced Acc</th><th>Per-Class F1</th></tr></thead>
                                        <tbody id="cwcv-table-body"></tbody>
                                    </table>
                                </div>
                                <h6 class="small fw-bold mt-3">Within-Well Performance</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm small">
                                        <thead><tr><th>Well</th><th>Samples</th><th>Classes</th><th>CV Accuracy</th></tr></thead>
                                        <tbody id="cwcv-within-body"></tbody>
                                    </table>
                                </div>
                                <div id="cwcv-recommendation" class="mt-3 small text-muted"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Expert Ensemble Results -->
                    <div id="ee-results" class="d-none mb-4">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-people"></i> Expert-Weighted Ensemble (RLHF-style)</div>
                            <div class="card-body">
                                <div id="ee-summary" class="mb-3"></div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <h6 class="small fw-bold">Model Weights</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm small">
                                                <thead><tr><th>Model</th><th>Base Weight</th><th>Expert Weight</th><th>CV Accuracy</th></tr></thead>
                                                <tbody id="ee-weights-body"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="small fw-bold">Per-Class Impact</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm small">
                                                <thead><tr><th>Class</th><th>Equal F1</th><th>Expert F1</th><th>Delta</th></tr></thead>
                                                <tbody id="ee-class-body"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Trail Tab -->
                <div id="tab-audit" class="tab-content">
                    <h5 class="mb-3"><i class="bi bi-shield-check"></i> Prediction Audit Trail</h5>
                    <p class="text-muted small">Every analysis action is recorded with timestamp, parameters, and result hash for regulatory compliance and traceability. Records are integrity-verified with SHA-256 hashes.</p>

                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="loadAuditLog()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Log
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportAuditLog()">
                            <i class="bi bi-download"></i> Export CSV
                        </button>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-label">Total Records</div>
                                <div class="metric-value" id="audit-total">0</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-label">App Version</div>
                                <div class="metric-value" id="audit-version">2.6.0</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-label">Session Start</div>
                                <div class="metric-value" id="audit-session-start" style="font-size:0.9rem">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Recent Analysis Actions</div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-striped mb-0" id="audit-table">
                                <thead><tr>
                                    <th>#</th><th>Time</th><th>Action</th><th>Well</th><th>Source</th><th>Elapsed</th><th>Hash</th>
                                </tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Glossary Tab -->
                <!-- Research & Methods Tab -->
                <div id="tab-research" class="tab-content">
                    <h5 class="mb-3"><i class="bi bi-mortarboard"></i> Scientific Methods & Research Basis</h5>
                    <p class="text-muted">Understanding what factors are accounted for and the scientific basis of each analysis. Based on peer-reviewed geomechanics research through 2025-2026.</p>

                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-sm" onclick="loadResearchMethods()">
                            <i class="bi bi-arrow-clockwise"></i> Load Methods
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="runPhysicsCheck()">
                            <i class="bi bi-gear-wide"></i> Physics Constraint Check
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="runPhysicsPredict()">
                            <i class="bi bi-shield-check"></i> Physics-Constrained Predict
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="runMisclassification()">
                            <i class="bi bi-bug"></i> Misclassification Analysis
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="runModelBias()">
                            <i class="bi bi-sliders2"></i> Bias Detection
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="runReliabilityReport()">
                            <i class="bi bi-award"></i> Reliability Report
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="runPredictWithAbstention()">
                            <i class="bi bi-shield-exclamation"></i> Predict with Abstention
                        </button>
                    </div>
                    <!-- Abstention threshold slider -->
                    <div class="mt-2 px-2" style="max-width:350px">
                        <label class="form-label small mb-0">Abstention Threshold:
                            <span id="abstention-threshold-val">60%</span></label>
                        <input type="range" class="form-range form-range-sm" id="abstention-threshold"
                               min="0.30" max="0.95" step="0.05" value="0.60">
                    </div>

                    <div id="research-body"></div>

                    <!-- Model Bias Results -->
                    <div id="bias-results" class="d-none mt-3">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-sliders2"></i> Model Bias Detection</div>
                            <div class="card-body" id="bias-body"></div>
                        </div>
                    </div>

                    <!-- Reliability Report Results -->
                    <div id="reliability-results" class="d-none mt-3">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark"><i class="bi bi-award"></i> Prediction Reliability Report</div>
                            <div class="card-body" id="reliability-body"></div>
                        </div>
                    </div>

                    <!-- Prediction Abstention Results -->
                    <div id="abstention-results" class="d-none mt-3">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <i class="bi bi-shield-exclamation"></i> Prediction Abstention — Safety-Critical Refusal
                            </div>
                            <div class="card-body" id="abstention-body"></div>
                        </div>
                    </div>

                    <!-- Physics Constrained Prediction Results -->
                    <div id="physics-predict-results" class="d-none mt-3">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-shield-check"></i> Physics-Constrained Prediction</div>
                            <div class="card-body" id="physics-predict-body"></div>
                        </div>
                    </div>

                    <!-- Misclassification Analysis Results -->
                    <div id="misclass-results" class="d-none mt-3">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-bug"></i> Misclassification Analysis</div>
                            <div class="card-body" id="misclass-body"></div>
                        </div>
                    </div>

                    <!-- Physics Check Results -->
                    <div id="physics-results" class="d-none mt-3">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-gear-wide"></i> Physics Constraint Validation</div>
                            <div class="card-body">
                                <div id="physics-status" class="alert mb-3"></div>
                                <div id="physics-issues"></div>
                                <div id="physics-constraints" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-glossary" class="tab-content">
                    <h5 class="mb-3"><i class="bi bi-book"></i> Geomechanics Glossary & Decision Guide</h5>
                    <p class="text-muted">Plain-language explanations for non-technical stakeholders. Understand what the numbers mean before making drilling decisions.</p>

                    <!-- Stress & Pressure -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white"><i class="bi bi-arrows-angle-expand"></i> Stress & Pressure Terms</div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-3">Principal Stresses (&#963;1, &#963;2, &#963;3)</dt>
                                <dd class="col-sm-9">The three main forces squeezing the rock underground, measured in MPa (megapascals). &#963;1 is the strongest, &#963;3 the weakest. <strong>Think of it as:</strong> squeezing a sponge from three sides &mdash; one direction always pushes hardest.</dd>

                                <dt class="col-sm-3">SHmax (Maximum Horizontal Stress Azimuth)</dt>
                                <dd class="col-sm-9">The compass direction of the strongest horizontal squeeze. <strong>Why it matters:</strong> Drilling perpendicular to SHmax reduces borehole instability. This is the single most important output for well planning. Reported as degrees from North (0-360).</dd>

                                <dt class="col-sm-3">R Ratio</dt>
                                <dd class="col-sm-9">How "round" vs "cigar-shaped" the stress ellipsoid is (0 to 1). R=0 means &#963;2 equals &#963;3, R=1 means &#963;2 equals &#963;1. <strong>Practical impact:</strong> R near 0.5 = all three stresses are distinct; near 0 or 1 = two stresses are similar, so stress direction is less constrained.</dd>

                                <dt class="col-sm-3">Pore Pressure (Pp)</dt>
                                <dd class="col-sm-9">The pressure of fluids (water, oil, gas) inside the rock pores, in MPa. Default estimate uses hydrostatic gradient (1020 kg/m3 water). <strong>Critical:</strong> Higher pore pressure makes fractures more likely to slip. This is consistently the #1 source of uncertainty in our analysis.</dd>

                                <dt class="col-sm-3">Overburden Stress (Sv)</dt>
                                <dd class="col-sm-9">The weight of all rock above a given depth. Calculated from rock density (2500 kg/m3) times depth times gravity. This sets the scale for all other stress estimates.</dd>
                            </dl>
                        </div>
                    </div>

                    <!-- Stress Regime -->
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white"><i class="bi bi-globe"></i> Stress Regimes (Faulting Styles)</div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-3">Normal Faulting</dt>
                                <dd class="col-sm-9">The vertical stress is the greatest (&#963;1 = Sv). Rock extends apart horizontally. <strong>Typical setting:</strong> rift basins, passive margins. Fractures tend to be steep and parallel to SHmax.</dd>

                                <dt class="col-sm-3">Strike-Slip</dt>
                                <dd class="col-sm-9">The vertical stress is intermediate (&#963;2 = Sv). Rock shears horizontally. <strong>Typical setting:</strong> transform boundaries. Both vertical and sub-horizontal fractures are common.</dd>

                                <dt class="col-sm-3">Thrust (Reverse) Faulting</dt>
                                <dd class="col-sm-9">The vertical stress is the weakest (&#963;3 = Sv). Rock compresses horizontally. <strong>Typical setting:</strong> compressional margins, fold-thrust belts. Low-angle fractures dominate.</dd>

                                <dt class="col-sm-3">Regime Confidence</dt>
                                <dd class="col-sm-9"><span class="badge bg-success">HIGH</span> = clear winner (1 regime fits much better). <span class="badge bg-warning text-dark">MODERATE</span> = likely but not definitive. <span class="badge bg-danger">LOW</span> = all regimes fit similarly; independent data (borehole breakouts, drilling-induced fractures) needed to resolve.</dd>
                            </dl>
                        </div>
                    </div>

                    <!-- Fracture Properties -->
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark"><i class="bi bi-hurricane"></i> Fracture Properties</div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-3">Fracture Azimuth</dt>
                                <dd class="col-sm-9">The compass direction the fracture plane faces (0-360 degrees from North). <strong>Example:</strong> Azimuth 90 = fracture faces East.</dd>

                                <dt class="col-sm-3">Fracture Dip</dt>
                                <dd class="col-sm-9">How steeply the fracture tilts from horizontal (0-90 degrees). 0 = flat; 90 = vertical.</dd>

                                <dt class="col-sm-3">Slip Tendency</dt>
                                <dd class="col-sm-9">How close a fracture is to sliding (shear stress / normal stress). <strong>Range:</strong> 0 to 1+. Values above the friction coefficient (~0.6) mean the fracture is likely sliding. <span class="text-danger fw-bold">High slip tendency = potential wellbore instability.</span></dd>

                                <dt class="col-sm-3">Dilation Tendency</dt>
                                <dd class="col-sm-9">How likely a fracture is to open and allow fluid flow (0 to 1). <strong>High values (>0.7):</strong> fracture is likely a fluid conduit. <span class="text-success fw-bold">Can be beneficial (natural fracture network) or harmful (lost circulation).</span></dd>

                                <dt class="col-sm-3">Critically Stressed</dt>
                                <dd class="col-sm-9">Fractures whose slip tendency exceeds the Mohr-Coulomb criterion. These fractures are at or past the point of failure. <strong>Operational impact:</strong> High % critically stressed = higher risk of induced seismicity, lost circulation, and wellbore instability.</dd>
                            </dl>
                        </div>
                    </div>

                    <!-- Risk Interpretation -->
                    <div class="card mb-3">
                        <div class="card-header bg-danger text-white"><i class="bi bi-shield-exclamation"></i> Risk Categories Explained</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead>
                                        <tr><th>Risk Level</th><th>What It Means</th><th>Recommended Action</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr class="table-success"><td><span class="badge bg-success">LOW</span></td><td>Critically stressed <20%, high data quality, good model confidence</td><td>Proceed with standard drilling program</td></tr>
                                        <tr class="table-warning"><td><span class="badge bg-warning text-dark">MODERATE</span></td><td>Some fractures at risk, moderate uncertainty</td><td>Use managed pressure drilling, plan contingencies</td></tr>
                                        <tr class="table-danger"><td><span class="badge bg-danger">HIGH</span></td><td>>30% critically stressed, low data quality or model confidence</td><td>Commission additional data before drilling. Consider alternative well trajectory.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Model Reliability -->
                    <div class="card mb-3">
                        <div class="card-header bg-secondary text-white"><i class="bi bi-robot"></i> Understanding AI Predictions</div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-3">Standard Accuracy</dt>
                                <dd class="col-sm-9">How often the model is correct overall. <strong>Limitation:</strong> Can be misleadingly high if one fracture type dominates. Example: if 50% of data is Vuggy, a model that always says "Vuggy" gets 50% accuracy while being useless.</dd>

                                <dt class="col-sm-3">Balanced Accuracy</dt>
                                <dd class="col-sm-9">Accuracy calculated separately for each fracture type, then averaged. <strong>More honest</strong> when class sizes differ. If standard accuracy is 88% but balanced is 56%, the model is failing on rare fracture types.</dd>

                                <dt class="col-sm-3">SMOTE (Synthetic Minority Over-sampling)</dt>
                                <dd class="col-sm-9">When some fracture types have very few samples, SMOTE creates realistic synthetic examples by interpolating between existing ones. This helps the model learn rare types. <strong>Automatically applied</strong> when class imbalance is detected.</dd>

                                <dt class="col-sm-3">Calibration (ECE)</dt>
                                <dd class="col-sm-9">Expected Calibration Error measures whether the model's confidence values are reliable. ECE <5% = excellent (confidence values can be trusted). ECE >20% = poor (don't rely on probability estimates).</dd>

                                <dt class="col-sm-3">Out-of-Distribution (OOD)</dt>
                                <dd class="col-sm-9">When you upload new data, we check if it looks similar to the training data. If the new data is "out of distribution" (different depth range, formation, etc.), model predictions will be unreliable. <span class="text-danger fw-bold">Always check OOD before trusting predictions on new data.</span></dd>

                                <dt class="col-sm-3">Overfitting</dt>
                                <dd class="col-sm-9">When a model memorizes the training data instead of learning general patterns. Measured by the gap between training accuracy and cross-validation accuracy. Gap >10% = significant overfitting risk.</dd>
                            </dl>
                        </div>
                    </div>

                    <!-- Decision Flowchart -->
                    <div class="card mb-3 border-success">
                        <div class="card-header bg-success text-white"><i class="bi bi-signpost-split"></i> Decision Flowchart: Should I Trust These Results?</div>
                        <div class="card-body">
                            <ol class="mb-0">
                                <li class="mb-2"><strong>Check Data Quality score.</strong> If grade is D or F, stop &mdash; fix data issues first.</li>
                                <li class="mb-2"><strong>Check Regime Confidence.</strong> If LOW, do not rely on SHmax direction. Collect borehole breakout data.</li>
                                <li class="mb-2"><strong>Check Balanced Accuracy.</strong> If below 60%, classification is unreliable. Consider merging rare fracture types or collecting more data.</li>
                                <li class="mb-2"><strong>If using uploaded data:</strong> Check the OOD (distribution) result. If HIGH severity, retrain before using predictions.</li>
                                <li class="mb-2"><strong>Check Calibration.</strong> If POOR, don't use probability values for risk decisions. Use binary yes/no classification instead.</li>
                                <li class="mb-2"><strong>Review the Risk Matrix.</strong> If HIGH risk, escalate to senior geomechanics engineer before proceeding.</li>
                                <li class="mb-2"><strong>Check the Uncertainty Budget.</strong> Pore pressure is consistently the #1 source of uncertainty. If you have measured Pp data, input it to dramatically improve reliability.</li>
                            </ol>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">GeoStress AI</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Initialize all Bootstrap tooltips
    document.addEventListener("DOMContentLoaded", function() {
        var ttEls = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        ttEls.forEach(function(el) { new bootstrap.Tooltip(el, {trigger: "hover focus", html: true}); });
    });
    </script>
    <script src="/static/js/app.js"></script>
</body>
</html>
